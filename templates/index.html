<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Caltech Volleyball Lineup Tracker</title>
<style>
body { margin:0; font-family:sans-serif; background-color:black; color:white; }
h1 { color:#FF6C0C; text-align:center; margin-bottom:20px; }
/* Titles row */
.titles { display:grid; grid-template-columns:250px 1fr 250px; gap:20px; padding:0 20px; margin-bottom:5px; }
.titles h2 { margin:0; text-align:center; color:white; }
/* Container */
.container { display:grid; grid-template-columns:250px 1fr 250px; gap:20px; padding:0 20px; }
/* Roster */
.roster { display:flex; flex-direction:column; gap:10px; margin-top:5px; }
.player-item { display:flex; align-items:center; gap:10px; padding:5px; border-left:4px solid #0f0; cursor:pointer; font-family:monospace; }
.player-item img { width:40px; height:40px; object-fit:cover; border-radius:50%; }
.player-number { font-weight:bold; margin-right:5px; font-family:"Courier New", Courier, monospace; }
/* Court */
.court-container { display:flex; flex-direction:column; align-items:center; position:relative; margin-top:5px; }
.court { display:grid; grid-template-columns: repeat(3, 140px); grid-template-rows: repeat(2, 140px); gap:15px; justify-content:center; align-items:center; margin-bottom:10px; }
.court .player { display:flex; flex-direction:column; align-items:center; justify-content:center; background:#222; border-radius:10px; padding:10px; width:140px; height:140px; cursor:pointer; transition: transform 0.2s; }
.court .player img { width:80px; height:80px; border-radius:50%; object-fit:cover; }
.court .player.selected { outline: 3px solid #0ff; }
.court.adjust-active { outline: 3px solid #FF6C0C; border-radius:12px; padding:8px; }
.net { grid-column: 1/4; text-align: center; font-weight: bold; color: white; font-size: 24px; position:relative; margin-bottom:10px; }
.net::after { content: ""; display: block; height: 2px; background: white; width: calc(3*140px + 2*15px); margin:5px auto 0 auto; }
.court-buttons { display:flex; justify-content:center; gap:10px; margin:5px 0; }
button { padding:6px 12px; cursor:pointer; border:none; border-radius:5px; font-size:14px; }
button#rotate, button#adjustLineupBtn { background:#FF6C0C; color:white; transition: 0.2s; }
button#adjustLineupBtn.active { outline: 3px solid #FF6C0C; }
.subs { display:flex; flex-direction:column; gap:15px; margin-top:5px; }
.subs h2 { text-align:center; margin:5px 0; color:white; }
.subs form { display:flex; flex-direction:column; gap:10px; }
.subs label { display:inline-block; margin-right:5px; font-size:16px; }
.subs select { padding:4px; font-size:16px; }
.sub-row { display:flex; align-items:center; gap:5px; }
</style>
</head>
<body>
<h1>Caltech Volleyball Lineup Tracker</h1>

<div class="titles">
  <h2>Roster</h2>
  <h2 style="visibility:hidden;">Placeholder</h2>
  <h2>Game</h2>
</div>

<div class="container">

  <!-- Roster (Left Column) -->
  <div class="roster">
    {% for p in roster %}
    <div class="player-item" style="border-color: hsl({{ loop.index*50 % 360 }},100%,50%)">
      <img src="{{ url_for('static', filename=p.image) if p.image else url_for('static', filename='default.png') }}">
      <span class="player-number">{{p.number}}</span>
      <span class="player-name">{{ p.name }}</span>
      <span class="player-score" id="score-roster-{{p.name}}">({{p.score}})</span>
    </div>
    {% endfor %}
  </div>

  <!-- Court (Center Column) -->
  <div class="court-container">
    <div class="court" id="court">
      <div class="net">Lineup</div>
      {% for p in on_court %}
      <div class="player" data-index="{{loop.index0}}">
        <img src="{{ url_for('static', filename=p.image) if p.image else url_for('static', filename='default.png') }}">
        <span class="player-number">{{p.number}}</span>
        <span class="player-name">{{ p.name }}</span>
        <span class="player-score" id="score-court-{{p.name}}">({{p.score}})</span>
      </div>
      {% endfor %}
    </div>

    <!-- Buttons -->
    <div class="court-buttons">
      <button type="button" id="rotate">Rotate</button>
      <button type="button" id="adjustLineupBtn">Adjust Lineup</button>
    </div>

    <!-- Points -->
    <div style="display:flex; justify-content:center; gap:20px; margin-top:15px;">
      <div style="display:flex; flex-direction:column; align-items:center; gap:5px;">
        <div style="text-align:center; font-weight:bold; margin-bottom:5px;">Caltech</div>
        <button type="button" id="addPointBtn" onclick="updateCourtPoints(1)"
                style="font-size:24px; padding:18px 35px; background:#28a745; color:white; border-radius:8px; border:none; cursor:pointer;">
          <span id="greenClicks">{{ green_clicks }}</span>
        </button>
      </div>
      <div style="display:flex; flex-direction:column; align-items:center; gap:5px;">
        <div style="text-align:center; font-weight:bold; margin-bottom:5px;">Opponent</div>
        <button type="button" id="removePointBtn" onclick="updateCourtPoints(-1)"
                style="font-size:24px; padding:18px 35px; background:#dc3545; color:white; border-radius:8px; border:none; cursor:pointer;">
          <span id="redClicks">{{ red_clicks }}</span>
        </button>
      </div>
      <div style="display:flex; flex-direction:column; align-items:center; gap:5px;">
        <div style="text-align:center; font-weight:bold; margin-bottom:5px;">Individual (-)</div>
        <button type="button" id="individualBtn"
                style="font-size:16px; padding:8px 16px; background:#8A2BE2; color:white; border-radius:8px; border:none; cursor:pointer;"
                onclick="toggleIndividual()">
          Select Player
        </button>
      </div>
    </div>
    <div style="display:flex; flex-direction:column; align-items:center; gap:5px; margin-top:15px;">
      <button type="button" id="undoBtn"
              style="font-size:12px; padding:12px 25px; background:#FFA500; color:white; border-radius:8px; border:none; cursor:pointer;">
        Undo
      </button>
    </div>
  </div> <!-- /.court-container -->

  <!-- Right Column: Game + Substitutions -->
  <div class="subs" style="display:flex; flex-direction:column; gap:20px;">

    <!-- Game Section -->
    <div class="game-section" style="text-align:center;">
      <div style="display:flex; justify-content:center; gap:20px; margin-top:10px;">
        <button type="button" id="newSetBtn"
                style="font-size:12px; padding:12px 25px; background:#007bff; color:white; border-radius:8px; border:none; cursor:pointer;">
          New Set
        </button>
        <button type="button" id="newMatchBtn"
                style="font-size:12px; padding:12px 25px; background:#007bff; color:white; border-radius:8px; border:none; cursor:pointer;">
          New Match
        </button>
      </div>
    </div>

    <!-- Substitutions Section -->
    <div style="margin-top:30px;">
      <h2>Substitutions</h2>
      <form id="subForm">
        <div class="sub-row">
          <label>Sub Out:</label>
          <select name="sub_out"></select>
        </div>
        <div class="sub-row">
          <label>Sub In:</label>
          <select name="sub_in"></select>
        </div>
        <button type="submit">Make Sub</button>
      </form>
    </div>

  </div> <!-- /.right column -->

</div> <!-- /.container -->


<script>
// ------------------ GLOBAL ------------------
let onCourtGlobal = {{ on_court|tojson }};
let rosterGlobal = {{ roster|tojson }};
let greenClicks = {{ green_clicks }};
let redClicks = {{ red_clicks }};

// ------------------ UPDATE UI ------------------
function updateCourtUI(data){
  const { on_court, roster } = data;

  // Update court
  const courtDivs = document.querySelectorAll('#court .player');
  courtDivs.forEach((div, idx) => {
    const player = on_court[idx];
    div.querySelector('.player-number').textContent = player.number;
    div.querySelector('.player-name').textContent = player.name;
    div.querySelector('img').src = player.image ? `/static/${player.image}` : '/static/default.png';
    const score = roster.find(p => p.name === player.name)?.score ?? 0;
    div.querySelector('.player-score').textContent = `(${score})`;
  });

  // Update roster scores
  roster.forEach(p => {
    const span = document.getElementById(`score-roster-${CSS.escape(p.name)}`);
    if(span) span.textContent = `(${p.score})`;
  });

  // Update sub dropdowns
  const subOut = document.querySelector('select[name="sub_out"]');
  const subIn = document.querySelector('select[name="sub_in"]');
  subOut.innerHTML = '';
  subIn.innerHTML = '';
  const onCourtNames = on_court.map(p=>p.name);
  on_court.forEach(p => subOut.innerHTML += `<option>${p.name}</option>`);
  roster.forEach(p => { if(!onCourtNames.includes(p.name)) subIn.innerHTML += `<option>${p.name}</option>` });

  // Update counters inside buttons
  document.getElementById('greenClicks').textContent = greenClicks;
  document.getElementById('redClicks').textContent = redClicks;
}

// ------------------ POINTS ------------------
async function updateCourtPoints(delta, players=null) {
  const names = players || onCourtGlobal.map(p => p.name);

  const res = await fetch('/update_points', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({delta, players: names})
  });
  const data = await res.json();

  // Update local globals
  rosterGlobal = data.roster;
  greenClicks = data.green_clicks;
  redClicks = data.red_clicks;

  // Refresh UI
  updateCourtUI({on_court: onCourtGlobal, roster: rosterGlobal});
}

// ------------------ ROTATE ------------------
document.getElementById('rotate').addEventListener('click', async () => {
  const res = await fetch('/rotate', {method:'POST'});
  const data = await res.json();
  onCourtGlobal = data.on_court;
  updateCourtUI(data);
});

// ------------------ SUB ------------------
document.getElementById('subForm').addEventListener('submit', async e => {
  e.preventDefault();
  const sub_out = e.target.sub_out.value;
  const sub_in = e.target.sub_in.value;

  const res = await fetch('/make_sub', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({sub_out, sub_in})
  });
  const data = await res.json();
  onCourtGlobal = data.on_court;
  updateCourtUI(data);
});

// ------------------ ADJUST LINEUP ------------------
let adjustMode = false, firstSelected = null;
const adjustBtn = document.getElementById('adjustLineupBtn');
const courtContainer = document.getElementById('court');

adjustBtn.addEventListener('click', () => {
  adjustMode = !adjustMode;
  if(adjustMode){
    adjustBtn.classList.add('active');
    courtContainer.classList.add('adjust-active');
  } else {
    adjustBtn.classList.remove('active');
    courtContainer.classList.remove('adjust-active');
    document.querySelectorAll('.player').forEach(p => p.classList.remove('selected'));
    firstSelected = null;
  }
});

// Delegate swap clicks to parent
courtContainer.addEventListener('click', async (e) => {
  const div = e.target.closest('.player');
  if(!div) return;

  // Handle adjust swaps
  if(adjustMode){
    if(!firstSelected){ firstSelected = div; div.classList.add('selected'); }
    else if(div !== firstSelected){
      const idx1 = parseInt(firstSelected.dataset.index);
      const idx2 = parseInt(div.dataset.index);

      // Swap in onCourtGlobal
      [onCourtGlobal[idx1], onCourtGlobal[idx2]] = [onCourtGlobal[idx2], onCourtGlobal[idx1]];

      // Swap DOM content
      const tempHTML = firstSelected.innerHTML;
      firstSelected.innerHTML = div.innerHTML;
      div.innerHTML = tempHTML;

      // Refresh scores
      await updateCourtPoints(0);

      firstSelected.classList.remove('selected');
      div.classList.remove('selected');
      firstSelected = null;

      // Update server order
      await fetch('/update_court', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(onCourtGlobal.map(p=>p.name))
      });
    }
    return;
  }

  // Handle individual (-)
  if(individualActive){
    const idx = parseInt(div.dataset.index);
    const player = onCourtGlobal[idx];

    await updateCourtPoints(-1, [player.name]);

    // Reset button highlight after selection
    individualActive = false;
    document.getElementById('individualBtn').style.outline = 'none';
    courtContainer.classList.remove('adjust-active');
  }
});

// ------------------ INDIVIDUAL MODE BUTTON ------------------
let individualActive = false;
document.getElementById('individualBtn').addEventListener('click', () => {
  individualActive = !individualActive;
  const btn = document.getElementById('individualBtn');
  if(individualActive){
    btn.style.outline = '3px solid #FF6C0C'; // Highlight active
    courtContainer.classList.add('adjust-active');
  } else {
    btn.style.outline = 'none';
    courtContainer.classList.remove('adjust-active');
  }
});

// ------------------ NEW SET / MATCH ------------------
document.getElementById('newSetBtn').addEventListener('click', async () => {
  const res = await fetch('/new_set', { method:'POST' });
  const data = await res.json();

  // Only reset green/red clicks (points)
  greenClicks = data.green_clicks;
  redClicks = data.red_clicks;
  updateCourtUI({on_court:onCourtGlobal, roster:rosterGlobal});
});

document.getElementById('newMatchBtn').addEventListener('click', async () => {
  const res = await fetch('/new_match', { method:'POST' });
  const data = await res.json();

  // Reset everything: scores on roster + green/red clicks
  rosterGlobal = data.roster;
  greenClicks = data.green_clicks;
  redClicks = data.red_clicks;
  updateCourtUI({on_court:onCourtGlobal, roster:rosterGlobal});
});

// ------------------ UNDO BUTTON ------------------
document.getElementById('undoBtn').addEventListener('click', async () => {
  const res = await fetch('/undo', { method:'POST' });
  if(res.ok){
    const data = await res.json();
    rosterGlobal = data.roster;
    greenClicks = data.green_clicks;
    redClicks = data.red_clicks;
    updateCourtUI({on_court:onCourtGlobal, roster:rosterGlobal});
  }
});

// ------------------ INITIAL RENDER ------------------
updateCourtUI({on_court:onCourtGlobal, roster:rosterGlobal});
</script>
